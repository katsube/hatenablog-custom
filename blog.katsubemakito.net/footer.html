<!-- ä¸Šã«ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³ -->
<div id="back-to-top"><i class="fa fa-arrow-up"></i></div>

<script type="text/javascript">
//--------------------------------------------------------------
// ãƒšãƒ¼ã‚¸å…¨ä½“
//--------------------------------------------------------------
window.addEventListener("DOMContentLoaded", ()=>{
  //-----------------------------------
  // ãƒ˜ãƒƒãƒ€ç”»åƒã‚’åºƒã’ã‚‹
  //-----------------------------------
  (() => {
    const blogTitle = document.querySelector("#blog-title");
    blogTitle.setAttribute("style",
      "background-image: url('https://cdn-ak.f.st-hatena.com/images/fotolife/k/katsube/20231006/20231006005542.jpg');" + 
      "background-repeat:no-repeat;"+
      "background-size: cover;" +
      "padding-top:0px;"
    );
      const blogTitleInner = document.querySelector("#blog-title-inner");
      blogTitleInner.setAttribute("style",
        "background-image: none;" +
        "padding-top: 20px;"
      );
  })();

  //-----------------------------------
  // ä¸Šã«ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³
  //-----------------------------------
  (() => {
    const btn = document.getElementById("back-to-top");
    if (!btn) return;
    const showOffset = 200;

    window.addEventListener("scroll", () => {
      const y = window.pageYOffset || document.documentElement.scrollTop;

      if (y > showOffset) {
        btn.classList.add("is-visible");
      }
      else if (y <= 10) {  // ä¸Šã«10pxä½™ç™½ãŒæ®‹ã£ã¦ã„ã¦ã‚‚ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
        btn.classList.remove("is-visible");
      }
    }, { passive: true });

    btn.addEventListener("click", () => {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    });
  })();


  //--------------------------------------------------------------
  // è¨˜äº‹ãƒšãƒ¼ã‚¸
  //--------------------------------------------------------------
  //----------------------------------------
  // SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
  //----------------------------------------
  (() => {
    const url = location.href;
    const title = document.title;

    // SNSã‚·ã‚§ã‚¢ãƒªãƒ³ã‚¯è¨­å®š
    document.querySelectorAll("[data-share]").forEach(el => {
      const type = el.dataset.share;
      let shareUrl = "";

      switch (type) {
        case "x":
          shareUrl = "https://twitter.com/intent/tweet?url=" + encodeURIComponent(url) + "&text=" + encodeURIComponent(title);
          break;
        case "facebook":
          shareUrl = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(url);
          break;
        case "hatena":
          shareUrl = "https://b.hatena.ne.jp/entry/" + encodeURIComponent(url);
          break;
      }
      el.href = shareUrl;
    });

    // URLã‚³ãƒ”ãƒ¼
    document.querySelectorAll(".share-btn.copy").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!navigator.clipboard) {
          alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“");
          return;
        }

        navigator.clipboard.writeText(url)
          .then(() => {
            alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          })
          .catch(() => {
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
          });
      });
    });
  })();

  //----------------------------------------
  // 2å¹´ä»¥ä¸Šå‰ã®æŠ•ç¨¿ãªã‚‰è­¦å‘Šæ–‡ã‚’è¿½åŠ 
  //----------------------------------------
  (()=>{
    const entrydate = document.querySelector('.entry .entry-inner .entry-header .entry-date time').getAttribute('datetime')
    const time = new Date(entrydate);
    const now = new Date();

    if (time.getFullYear() < (now.getFullYear() - 2)) {
          const year_diff = Math.floor( (now.getTime() - time.getTime()) / (1000 * 60 * 60 * 24 * 365) );
      const entry = document.querySelector('.entry-content');
      const div  = document.createElement('div');
      div.classList.add('ws-info1');
      div.innerHTML = `<i class="fa-solid fa-circle-info fa-xl"></i> ã“ã®è¨˜äº‹ã¯<strong>${year_diff}å¹´ä»¥ä¸Šå‰</strong>ã«æŠ•ç¨¿ã•ã‚ŒãŸã‚‚ã®ã§ã™`;
      entry.insertBefore(div, entry.firstChild);
    }
  })();

  //-----------------------------------
  // ç›®æ¬¡ã‚’olã«ç½®æ›
  //-----------------------------------
  (()=>{
    const uls = document.querySelectorAll('.table-of-contents ul, .table-of-contents');
    Array.from(uls).forEach(ul => {
      const ol = document.createElement('ol');
      for (const attr of ul.attributes) {
        ol.setAttribute(attr.name, attr.value);
      }

      while (ul.firstChild) {
        ol.appendChild(ul.firstChild);
      }

      ul.parentNode.replaceChild(ol, ul);
    });
  })();

  //-----------------------------------
  // codeå†…ã«è¨€èªåã‚’è¡¨ç¤º
  //-----------------------------------
  (()=>{
    const onLoad = () => {
      document.querySelectorAll("pre.code").forEach( (code)=>{
        const lang = code.getAttribute("data-lang");
        if ( lang ) {
          code.dataset.langLabel =  lang;
        }
      });
    };
    window.addEventListener("load", onLoad);
  })();

  //-----------------------------------
  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„
  //-----------------------------------
  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã¨ãƒœã‚¿ãƒ³ã‚’ç›®ç«‹ãŸã›ã‚‹
  (() => {
    // ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã¯é©ç”¨ã—ãªã„
    const entries = document.querySelectorAll(".entry-content");
    if (entries.length !== 1)
      return;

    // ã‚¯ãƒ©ã‚¹è¿½åŠ 
    const box = document.querySelector(".js-comment-box");
    const btn = box?.querySelector(".js-leave-comment-title");
    if (!box || !btn)
      return;
    box.classList.add("comment-cta-big");

    // æ–‡è¨€è¿½åŠ 
    const after = document.createElement("p");
    after.className = "comment-note after";
    after.innerHTML = 'æ„Ÿæƒ³ã‚„è³ªå•ãªã©ãŠæ°—è»½ã«ã©ã†ãã€‚<br>ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€ã«ã¯ã€Œ<a href="https://www.hatena.ne.jp/" target="_blank"><u>ã¯ã¦ãª</u></a>ã€ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§<a href="https://accounts.hatena.ne.jp/login"><u>ãƒ­ã‚°ã‚¤ãƒ³</u></a>ãŒå¿…è¦ã§ã™ã€‚';
    box.appendChild(after);

    // ãƒœã‚¿ãƒ³ã®æ–‡è¨€è¨­å®š
    btn.innerHTML = "ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã";
  })();

  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«idä»˜ä¸
  (() => {
    const commentBox =
      document.querySelector('.comment-box')
      || document.querySelector('.js-comment-box');

    if (commentBox && !commentBox.id) {
      commentBox.id = 'comment-area';
    }
  })();

  //----------------------------------------
  // è¨˜äº‹ä¸­ã«AdSenseã‚’è‡ªç„¶é…ç½®
  //----------------------------------------
  (() => {
    // åºƒå‘ŠDOMç”Ÿæˆ
    const createAd = () => {
      const div = document.createElement('div');
      div.style.cssText = 'text-align:center; color:lightgray; margin:32px 8px;';
      div.textContent = '- Sponsored Link -';

      const script = document.createElement('script');
      script.async = true;
      script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5907690882482255';
      script.crossOrigin = 'anonymous';

      const ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.cssText = 'display:inline-block;width:656px;height:180px';
      ins.dataset.adClient = 'ca-pub-5907690882482255';
      ins.dataset.adSlot = '1452100314';

      const script2 = document.createElement('script');
      script2.textContent = '(adsbygoogle = window.adsbygoogle || []).push({});';

      div.append(script, ins, script2);
      return div;
    };

    // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    const isHeading   = el => el && /^H[1-6]$/.test(el.tagName);
    const isForbidden = el => el.closest('pre, code, ul, ol, blockquote, .hatena-asin-detail, .amazlet-box');

    // å¯¾è±¡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    const content = document.querySelector('.entry-content');
    if (!content) return;

    // â‘  TOCç›´ä¸‹ã«å¿…ãš1ä»¶
    const toc = content.querySelector('.table-of-contents');
    if (toc) {
      toc.after(createAd());
    }

    // â‘¡ å…¨ä½“æ–‡å­—é‡ã‚’è¨ˆç®—
    const paragraphs = [...content.querySelectorAll('p')]
      .filter(p => !isForbidden(p));
    const totalChars = paragraphs
      .map(p => p.textContent.length)
      .reduce((a, b) => a + b, 0);

    // â‘¢ æ²è¼‰æ•°ã‚’æ±ºå®šï¼ˆæœ¬æ–‡åˆ†ï¼‰
    const MAX_ADS = 3;          // æœ¬æ–‡ä¸­ã®æœ€å¤§æ•°
    const charsPerAd = 1000;

    const adCount = Math.min(
      MAX_ADS,
      Math.floor(totalChars / charsPerAd)
    );

    if (adCount === 0) return;

    // â‘£ å‡ç­‰é…ç½®
    const interval = totalChars / (adCount + 1);
    let acc = 0;
    let inserted = 0;
    let nextTarget = interval;

    for (const p of paragraphs) {
      acc += p.textContent.length;

      if (
        acc >= nextTarget &&
        inserted < adCount &&
        !isHeading(p.previousElementSibling) // â† è¦‹å‡ºã—ç›´ä¸‹ã‚’å®Œå…¨å›é¿
      ) {
        p.before(createAd());
        inserted++;
        nextTarget += interval;
      }
    }
  })();

// DOMContentLoaded
});
</script>